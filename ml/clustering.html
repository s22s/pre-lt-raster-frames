<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106630615-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments)};
gtag('js', new Date());

gtag('config', 'UA-106630615-1');
</script>

<title>Clustering · RasterFrames</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='RasterFrames brings the power of Spark DataFrames to geospatial raster data, empowered by the map algebra and tile layer operations of GeoTrellis'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<link rel="icon" href="../images/RasterFrames_16x16.ico" sizes="16x16"/>
<link rel="icon" href="i../mages/RasterFrames_32x32.ico" sizes="32x32"/>

<style>
.md-left { float: left; }
.md-right { float: right; }
.md-clear { clear: both; }
</style>
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>RasterFrames
</a>
<div class="version-number">
0.6.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-python">Python</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../creating-rasterframes.html" class="page">Creating RasterFrames</a></li>
  <li><a href="../spatial-queries.html" class="page">Spatial Queries</a></li>
  <li><a href="../apps/index.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/geotrellis-ops.html" class="page">GeoTrellis Operations</a></li>
    <li><a href="../apps/ndvi.html" class="page">Computing NDVI</a></li>
  </ul></li>
  <li><a href="../ml/index.html" class="page">Machine Learning</a>
  <ul>
    <li><a href="../ml/statistics.html" class="page">Raster Statistics</a></li>
    <li><a href="../ml/clustering.html" class="active page">Clustering</a></li>
    <li><a href="../ml/classification.html" class="page">Classification</a></li>
  </ul></li>
  <li><a href="../exporting-rasterframes.html" class="page">Exporting RasterFrames</a></li>
  <li><a href="../reference.html" class="page">Reference</a></li>
  <li><a href="../release-notes.html" class="page">Release Notes</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<img style="max-height: 60px;" src="../images/RasterFramesLogo.png" />
<!-- <div class="title"><a href="../index.html">RasterFrames</a></div>
 -->
<a href="http://www.astraea.earth" class="logo show-for-medium">
<img style="max-height: 40px;" src="../images/astraea.png"/>
</a>
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>RasterFrames
</a>
<div class="version-number">
0.6.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-python">Python</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../creating-rasterframes.html" class="page">Creating RasterFrames</a></li>
  <li><a href="../spatial-queries.html" class="page">Spatial Queries</a></li>
  <li><a href="../apps/index.html" class="page">Applications</a>
  <ul>
    <li><a href="../apps/geotrellis-ops.html" class="page">GeoTrellis Operations</a></li>
    <li><a href="../apps/ndvi.html" class="page">Computing NDVI</a></li>
  </ul></li>
  <li><a href="../ml/index.html" class="page">Machine Learning</a>
  <ul>
    <li><a href="../ml/statistics.html" class="page">Raster Statistics</a></li>
    <li><a href="../ml/clustering.html" class="active page">Clustering</a></li>
    <li><a href="../ml/classification.html" class="page">Classification</a></li>
  </ul></li>
  <li><a href="../exporting-rasterframes.html" class="page">Exporting RasterFrames</a></li>
  <li><a href="../reference.html" class="page">Reference</a></li>
  <li><a href="../release-notes.html" class="page">Release Notes</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">RasterFrames</a></li>
  <li><a href="../ml/index.html">Machine Learning</a></li>
  <li>Clustering</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#clustering" name="clustering" class="anchor"><span class="anchor-link"></span></a>Clustering</h1>
<p>In this example we will do some simple cell clustering based on multiband imagery.</p>
<h2><a href="#setup" name="setup" class="anchor"><span class="anchor-link"></span></a>Setup</h2>
<p>First some setup:</p>
<pre class="prettyprint"><code class="language-scala">import astraea.spark.rasterframes._
import astraea.spark.rasterframes.ml.TileExploder
import geotrellis.raster.io.geotiff.SinglebandGeoTiff
import geotrellis.raster._
import geotrellis.raster.render._
import org.apache.spark.ml.Pipeline
import org.apache.spark.ml.clustering.{KMeans, KMeansModel}
import org.apache.spark.ml.feature.VectorAssembler
import org.apache.spark.sql._

// Utility for reading imagery from our test data set
def readTiff(name: String): SinglebandGeoTiff = SinglebandGeoTiff(s&quot;../core/src/test/resources/$name&quot;)

implicit val spark = SparkSession.builder().
  master(&quot;local[*]&quot;).appName(getClass.getName).getOrCreate().withRasterFrames
spark.sparkContext.setLogLevel(&quot;ERROR&quot;)

import spark.implicits._
</code></pre>
<h2><a href="#loading-data" name="loading-data" class="anchor"><span class="anchor-link"></span></a>Loading Data</h2>
<p>The first step is to load multiple bands of imagery and construct a single RasterFrame from them.</p>
<pre class="prettyprint"><code class="language-scala">val filenamePattern = &quot;L8-B%d-Elkton-VA.tiff&quot;
val bandNumbers = 1 to 4
val bandColNames = bandNumbers.map(b ⇒ s&quot;band_$b&quot;).toArray

// For each identified band, load the associated image file, convert to a RasterFrame, and join
val joinedRF = bandNumbers.
  map { b ⇒ (b, filenamePattern.format(b)) }.
  map { case (b, f) ⇒ (b, readTiff(f)) }.
  map { case (b, t) ⇒ t.projectedRaster.toRF(s&quot;band_$b&quot;) }.
  reduce(_ spatialJoin _)
</code></pre>
<p>We should see a single <code>spatial_key</code> column along with 4 columns of tiles.</p>
<pre class="prettyprint"><code class="language-scala">scala&gt; joinedRF.printSchema()
root
 |-- spatial_key: struct (nullable = true)
 |    |-- col: integer (nullable = false)
 |    |-- row: integer (nullable = false)
 |-- band_1: rf_tile (nullable = true)
 |-- band_2: rf_tile (nullable = true)
 |-- band_3: rf_tile (nullable = true)
 |-- band_4: rf_tile (nullable = true)

</code></pre>
<h2><a href="#ml-pipeline" name="ml-pipeline" class="anchor"><span class="anchor-link"></span></a>ML Pipeline</h2>
<p>SparkML requires that each observation be in its own row, and those observations be packed into a single <code>Vector</code>. The first step is to &ldquo;explode&rdquo; the tiles into a single row per cell/pixel.</p>
<pre class="prettyprint"><code class="language-scala">val exploder = new TileExploder()
</code></pre>
<p>To &ldquo;vectorize&rdquo; the the band columns, as required by SparkML, we use the SparkML <code>VectorAssembler</code>. We then configure our algorithm, create the transformation pipeline, and train our model. (Note: the selected value of <em>K</em> below is arbitrary.) </p>
<pre class="prettyprint"><code class="language-scala">val assembler = new VectorAssembler().
  setInputCols(bandColNames).
  setOutputCol(&quot;features&quot;)

// Configure our clustering algorithm
val k = 5
val kmeans = new KMeans().setK(k)

// Combine the two stages
val pipeline = new Pipeline().setStages(Array(exploder, assembler, kmeans))

// Compute clusters
val model = pipeline.fit(joinedRF)
</code></pre>
<h2><a href="#model-evaluation" name="model-evaluation" class="anchor"><span class="anchor-link"></span></a>Model Evaluation</h2>
<p>At this point the model can be saved off for later use, or used immediately on the same data we used to compute the model. First we run the data through the model to assign cluster IDs to each cell.</p>
<pre class="prettyprint"><code class="language-scala">scala&gt; val clustered = model.transform(joinedRF)
clustered: org.apache.spark.sql.DataFrame = [spatial_key: struct&lt;col: int, row: int&gt;, column_index: int ... 7 more fields]

scala&gt; clustered.show(8)
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
|spatial_key|column_index|row_index| band_1|band_2|band_3|band_4|            features|prediction|
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
|      [0,0]|           0|        0| 9470.0|8491.0|7805.0|6697.0|[9470.0,8491.0,78...|         1|
|      [0,0]|           1|        0| 9566.0|8607.0|8046.0|6898.0|[9566.0,8607.0,80...|         1|
|      [0,0]|           2|        0| 9703.0|8808.0|8377.0|7222.0|[9703.0,8808.0,83...|         0|
|      [0,0]|           3|        0| 9856.0|8983.0|8565.0|7557.0|[9856.0,8983.0,85...|         0|
|      [0,0]|           4|        0|10105.0|9270.0|8851.0|7912.0|[10105.0,9270.0,8...|         0|
|      [0,0]|           5|        0|10273.0|9463.0|9196.0|8341.0|[10273.0,9463.0,9...|         2|
|      [0,0]|           6|        0| 9920.0|9077.0|8480.0|7534.0|[9920.0,9077.0,84...|         0|
|      [0,0]|           7|        0| 9559.0|8603.0|7847.0|6829.0|[9559.0,8603.0,78...|         1|
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
only showing top 8 rows

</code></pre>
<p>If we want to inspect the model statistics, the SparkML API requires us to go through this unfortunate contortion:</p>
<pre class="prettyprint"><code class="language-scala">val clusterResults = model.stages.collect{ case km: KMeansModel ⇒ km}.head
</code></pre>
<p>Compute sum of squared distances of points to their nearest center:</p>
<pre class="prettyprint"><code class="language-scala">scala&gt; val metric = clusterResults.computeCost(clustered)
metric: Double = 1.0416215116259007E10

scala&gt; println(&quot;Within set sum of squared errors: &quot; + metric)
Within set sum of squared errors: 1.0416215116259007E10
</code></pre>
<h2><a href="#visualizing-results" name="visualizing-results" class="anchor"><span class="anchor-link"></span></a>Visualizing Results</h2>
<p>The predictions are in a DataFrame with each row representing a separate pixel. To assemble a raster to visualize the cluster assignments, we have to go through a multi-stage process to get the data back in tile form, and from there to combined raster form.</p>
<p>First, we get the DataFrame back into RasterFrame form:</p>
<pre class="prettyprint"><code class="language-scala">val tlm = joinedRF.tileLayerMetadata.left.get

val retiled = clustered.groupBy($&quot;spatial_key&quot;).agg(
  assembleTile(
    $&quot;column_index&quot;, $&quot;row_index&quot;, $&quot;prediction&quot;,
    tlm.tileCols, tlm.tileRows, ByteConstantNoDataCellType
  )
)

val rf = retiled.asRF($&quot;spatial_key&quot;, tlm)
</code></pre>
<p>To render our visualization, we convert to a raster first, and then use an <code>IndexedColorMap</code> to assign each discrete cluster a different color, and finally rendering to a PNG file.</p>
<pre class="prettyprint"><code class="language-scala">val raster = rf.toRaster($&quot;prediction&quot;, 186, 169)

val clusterColors = IndexedColorMap.fromColorMap(
  ColorRamps.Viridis.toColorMap((0 until k).toArray)
)

raster.tile.renderPng(clusterColors).write(&quot;target/scala-2.11/tut/ml/clustered.png&quot;)
</code></pre>
<table>
  <thead>
    <tr>
      <th>Color Composite </th>
      <th>Cluster Assignments </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><img src="L8-RGB-VA.png" /> </td>
      <td><img src="clustered.png" /> </td>
    </tr>
  </tbody>
</table>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../ml/classification.html">Classification</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../ml/clustering.html#clustering" class="header">Clustering</a>
  <ul>
    <li><a href="../ml/clustering.html#setup" class="header">Setup</a></li>
    <li><a href="../ml/clustering.html#loading-data" class="header">Loading Data</a></li>
    <li><a href="../ml/clustering.html#ml-pipeline" class="header">ML Pipeline</a></li>
    <li><a href="../ml/clustering.html#model-evaluation" class="header">Model Evaluation</a></li>
    <li><a href="../ml/clustering.html#visualizing-results" class="header">Visualizing Results</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">
<div class="small-12 text-center large-9 column">
<div class="copyright">
<span class="text">&copy; 2018
<a href="http://www.astraea.earth/">Astraea, Inc.</a></span>
</div>
</div>
</div>
</div>
</div>
</section>
</footer>
</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>

</html>
